name: Build Windows

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      # ç¼“å­˜ vcpkg å®‰è£…çš„ä¾èµ–ï¼ŒåŠ é€Ÿåç»­æ„å»º
      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
          key: ${{ runner.os }}-vcpkg-rocksdb-${{ hashFiles('**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-rocksdb-

      - name: Install vcpkg
        run: |
          if (-not (Test-Path "C:\vcpkg")) {
            git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
            C:\vcpkg\bootstrap-vcpkg.bat
          }
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV

      - name: Install RocksDB and dependencies
        run: |
          C:\vcpkg\vcpkg install rocksdb:x64-windows
          C:\vcpkg\vcpkg install snappy:x64-windows
          C:\vcpkg\vcpkg install lz4:x64-windows
          C:\vcpkg\vcpkg install zstd:x64-windows

      - name: Build Web UI (if needed)
        run: |
          # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ„å»ºå¥½çš„ Web UI
          if (-not (Test-Path "internal\webui\dist\index.html")) {
            Write-Host "Web UI not built, skipping (using existing embedded files)"
          } else {
            Write-Host "Web UI already exists"
          }

      - name: Set version
        id: version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -match 'refs/tags/(.*)') {
            $VERSION = $matches[1]
          } else {
            $VERSION = "dev-$(git rev-parse --short HEAD)"
          }
          echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build for Windows amd64
        env:
          CGO_ENABLED: 1
          GOOS: windows
          GOARCH: amd64
          CGO_CFLAGS: "-IC:/vcpkg/installed/x64-windows/include"
          CGO_LDFLAGS: "-LC:/vcpkg/installed/x64-windows/lib -lrocksdb"
        run: |
          $VERSION = "${{ steps.version.outputs.VERSION }}"
          go build -ldflags "-X main.version=$VERSION" -o build/rocksdb-cli-windows-amd64.exe ./cmd

      - name: Test executable
        run: |
          ./build/rocksdb-cli-windows-amd64.exe --help

      - name: Create package
        run: |
          New-Item -ItemType Directory -Force -Path release
          Copy-Item build/rocksdb-cli-windows-amd64.exe release/
          Copy-Item README.md release/
          Copy-Item BUILD.md release/

          # åˆ›å»ºå‹ç¼©åŒ…
          Compress-Archive -Path release/* -DestinationPath rocksdb-cli-windows-amd64.zip

      - name: Generate checksum
        run: |
          $hash = Get-FileHash -Path rocksdb-cli-windows-amd64.zip -Algorithm SHA256
          $hash.Hash + "  rocksdb-cli-windows-amd64.zip" | Out-File -FilePath checksums.txt -Encoding ASCII

      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: rocksdb-cli-windows-amd64
          path: build/rocksdb-cli-windows-amd64.exe
          retention-days: 30

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: rocksdb-cli-windows-package
          path: |
            rocksdb-cli-windows-amd64.zip
            checksums.txt
          retention-days: 30

      # å¦‚æœæ˜¯ tag æ¨é€ï¼Œåˆ›å»º Release
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            rocksdb-cli-windows-amd64.zip
            checksums.txt
          body: |
            ## ğŸ‰ Windows Release ${{ steps.version.outputs.VERSION }}

            ### ğŸ“¦ ä¸‹è½½
            - **rocksdb-cli-windows-amd64.zip** - Windows 64ä½å¯æ‰§è¡Œæ–‡ä»¶åŠæ–‡æ¡£

            ### ğŸ“ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ `rocksdb-cli-windows-amd64.zip`
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. è¿è¡Œ `rocksdb-cli-windows-amd64.exe`

            ### âœ… æ ¡éªŒå’Œ
            ä½¿ç”¨ `checksums.txt` éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
            ```powershell
            Get-FileHash rocksdb-cli-windows-amd64.zip -Algorithm SHA256
            ```

            ### ğŸ“– ä½¿ç”¨æ–‡æ¡£
            æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
